<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Quiz Generator Avanzato</title>
    <!-- Caricamento di Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configurazione Font Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Sfondo grigio chiaro */
        }
        /* Stili per il contenitore principale */
        .app-shell {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        /* Stile pulsante primario */
        .btn-primary {
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* Indigo-700 */
        }
        /* Stili per la barra di caricamento */
        .loading-bar {
            width: 0%;
            height: 100%;
            transition: width 0.5s ease-in-out;
            border-radius: 9999px; 
        }
        /* Stili per la stampa/PDF (Nasconde elementi non necessari e ottimizza layout) */
        @media print {
            .no-print {
                display: none !important;
            }
            .app-shell {
                max-width: 100%;
                padding: 0;
            }
            body {
                background-color: white;
            }
            /* Intestazione ufficiale per PDF */
            .official-header {
                display: block !important;
                border-bottom: 3px double #000; /* Stile più ufficiale */
                padding-bottom: 1rem;
                margin-bottom: 2rem;
            }
            /* Forza margini e sfondo bianco per tutto il contenuto */
            #printable-area, .card, body {
                box-shadow: none !important;
                border-radius: 0 !important;
                padding: 0 !important;
                margin: 0 !important;
                background-color: white !important;
            }
            /* Aumenta lo spazio per la firma */
            .signature-area {
                min-height: 150px;
            }
            /* Nasconde gli input radio per la stampa della verifica */
            .quiz-content input[type="radio"], .quiz-content input[type="text"], .quiz-content textarea {
                border: none;
                background-color: #f7f7f7;
                padding: 0.5rem;
            }
            .quiz-content textarea {
                border-left: 3px solid #ccc;
            }
        }
        /* Stile base per le card (migliorato) */
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
        }
    </style>
</head>
<body>

    <div class="min-h-screen bg-gray-100">
        <!-- Header (Visibile solo al docente per navigazione) -->
        <header class="bg-white shadow no-print">
            <div class="app-shell flex justify-between items-center py-4">
                <h1 class="text-2xl font-extrabold text-indigo-600">Smart Quiz Generator</h1>
                <div id="user-info" class="text-sm text-gray-500">In attesa autenticazione...</div>
            </div>
        </header>

        <!-- Contenitore Principale dell'Applicazione -->
        <main class="app-shell">
            <div id="app-container">
                <!-- Il contenuto verrà iniettato qui -->
                <div class="text-center p-10 text-gray-500">Caricamento dell'applicazione in corso...</div>
            </div>
        </main>
    </div>

    <!-- Modale di Messaggio (per sostituire alert/confirm) -->
    <div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 transition-opacity">
        <div class="bg-white rounded-xl p-6 max-w-sm mx-auto shadow-2xl">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4">Messaggio</h3>
            <p id="modal-message" class="text-gray-600 mb-6">Contenuto del messaggio.</p>
            <div class="flex justify-end">
                <button onclick="document.getElementById('modal').classList.add('hidden'); document.getElementById('modal').classList.remove('flex');" class="btn-primary px-4 py-2 rounded-lg font-semibold">
                    OK
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        // Importa i moduli Firebase necessari
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            addDoc, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAZIONE GLOBALE (FORNITA DALL'AMBIENTE) ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let app;
        let db;
        let auth;
        let userId = null;
        let currentRoute = 'login';
        let verificationsData = []; 
        const API_KEY = ""; // L'API Key di Gemini è gestita dall'ambiente di esecuzione

        // Elenco delle classi definite dall'utente
        const ALL_CLASSES = ['prima B', 'seconda I', 'seconda L', 'terza I', 'terza L', 'quinta I', 'quinta L'];


        // --- FUNZIONI UTILITY GLOBALI ---

        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal').classList.add('flex');
            document.getElementById('modal').classList.remove('hidden');
        }

        // Funzione per leggere i parametri dalla porzione hash dell'URL
        function getRouteParams() {
            const hash = window.location.hash.substring(1); // Rimuove il '#' iniziale
            return new URLSearchParams(hash);
        }

        function navigate(newRoute, params = {}) {
            currentRoute = newRoute;
            
            // Usiamo URLSearchParams per costruire i parametri del nuovo hash
            const newParams = new URLSearchParams();
            newParams.set('page', newRoute);

            // Pulisce i parametri non necessari per la rotta specifica
            if (newRoute !== 'results' && newRoute !== 'quiz' && newRoute !== 'student-login') {
                newParams.delete('vId');
            }
            if (newRoute !== 'dashboard') {
                newParams.delete('links');
            }

            // Aggiunge i nuovi parametri
            Object.keys(params).forEach(key => {
                if (params[key] !== null) {
                    newParams.set(key, params[key]);
                }
            });

            // Usa l'hash (frammento) per il routing per evitare errori SecurityError in ambienti blob:
            window.location.hash = '#' + newParams.toString();
            renderApp();
        }

        window.addEventListener('hashchange', () => {
            const urlParams = getRouteParams();
            const newPage = urlParams.get('page') || 'dashboard';
            if (currentRoute !== newPage) {
                currentRoute = newPage;
                renderApp();
            }
        });


        function copyToClipboard(elementId) {
            const copyText = document.getElementById(elementId);
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            try {
                // Utilizza document.execCommand('copy') come fallback robusto
                document.execCommand('copy'); 
                showModal("Copiato!", `Il link è stato copiato negli appunti: ${copyText.value}`);
            } catch (err) {
                console.error('Copy command failed:', err);
                showModal("Errore Copia", "Impossibile copiare il link automaticamente. Copia manualmente.");
            }
        }

        window.copyToClipboard = copyToClipboard;
        window.navigate = navigate;


        // --- GESTIONE DEI DATI FIRESTORE ---

        const getTeacherQuizCollection = (uid) => collection(db, `artifacts/${APP_ID}/users/${uid}/quizzes`);
        const getPublicVerificationCollection = () => collection(db, `artifacts/${APP_ID}/public/data/verifications`);
        const getPublicResultsCollection = () => collection(db, `artifacts/${APP_ID}/public/data/results`);

        function setupFirestoreListeners() {
            if (!db || !userId) return;

            // Ascolto per le Verifiche e Risultati (dati pubblici per la dashboard del docente)
            onSnapshot(getPublicVerificationCollection(), async (snapshot) => {
                const newVerificationsData = [];
                const verificationPromises = [];

                // Ottiene solo le verifiche create da questo utente
                const userVerificationDocs = snapshot.docs.filter(docSnap => docSnap.data().creatorId === userId);

                userVerificationDocs.forEach(docSnap => {
                    const verification = { id: docSnap.id, ...docSnap.data() };
                    
                    const resultDocRef = doc(getPublicResultsCollection(), verification.id);
                    verificationPromises.push(getDoc(resultDocRef).then(resultSnap => {
                        verification.result = resultSnap.exists() ? resultSnap.data() : null;
                        newVerificationsData.push(verification);
                    }).catch(e => {
                        console.error("Errore durante il fetch del risultato:", e);
                        newVerificationsData.push(verification);
                    }));
                });

                await Promise.all(verificationPromises);
                // Ordina in memoria per data di creazione (dal più recente)
                verificationsData = newVerificationsData.sort((a, b) => {
                    const dateA = b.creationDate?.seconds || 0;
                    const dateB = a.creationDate?.seconds || 0;
                    return dateA - dateB;
                });

                if (currentRoute === 'dashboard') {
                    renderDashboard();
                }
            });

            // Inizializza il routing
            const urlParams = getRouteParams();
            const page = urlParams.get('page');
            const verificationId = urlParams.get('vId');
            
            let routeToRender;
            if (verificationId) {
                routeToRender = page === 'results' ? 'results' : (page === 'quiz' ? 'quiz' : 'student-login');
            } else {
                routeToRender = page || 'dashboard';
            }
            
            currentRoute = routeToRender;
            if (currentRoute !== 'dashboard') {
                 renderApp();
            }
        }

        // --- GESTIONE AUTENTICAZIONE e AVVIO APP ---

        function initializeAppAndAuth() {
            if (firebaseConfig) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-info').textContent = `ID Docente: ${userId.substring(0, 8)}...`;
                        setupFirestoreListeners();
                    } else {
                        try {
                           if (!auth.currentUser) {
                               if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } else {
                                    await signInAnonymously(auth);
                                }
                           }
                        } catch (error) {
                            console.error("Errore nel tentativo di sign-in:", error);
                            document.getElementById('user-info').textContent = `Errore Autenticazione`;
                        }
                    }
                });
                
                if (initialAuthToken) {
                     signInWithCustomToken(auth, initialAuthToken).catch(e => console.error("Token initial failed:", e));
                } else {
                     signInAnonymously(auth).catch(e => console.error("Anon sign in failed:", e));
                }

            } else {
                console.error("Errore: configurazione Firebase non trovata.");
                document.getElementById('app-container').innerHTML = '<div class="text-center p-10 text-red-600">Errore critico: Configurazione Firebase mancante.</div>';
            }
        }


        // --- LOGICA DI GENERAZIONE QUIZ (GEMINI API) ---

        async function generateQuizContent(topic, complexity) {
            const systemPrompt = `Sei un esperto creatore di verifiche di Informatica/Tecnologia. Genera un JSON per una verifica dettagliata su "${topic}". La verifica deve essere molto complessa, articolata e contenere un mix di 15-20 domande di tipo risposta multipla, aperta e pratiche/testuali. Deve essere completabile in 60-90 minuti.
            
            Includi link a immagini placeholder (es: https://placehold.co/400x250/F0F4FF/4F46E5?text=Diagramma) per gli esercizi che richiedono diagrammi o figure complesse. Assegna punti per ogni domanda (Max totale 100).
            
            DEVI usare questo schema JSON. L'italiano DEVE essere l'unica lingua usata nel testo.
            
            Schema per la Rubrica: La rubrica deve convertire il punteggio totale (su 100) in un voto in decimi con un giudizio.
            Esempio: {"0-50": "Insufficiente (4)", "51-65": "Sufficiente (6)", "66-75": "Discreto (7)", "76-85": "Buono (8)", "86-95": "Ottimo (9)", "96-100": "Eccellente (10)"}.
            `;

            const userQuery = `Crea una verifica di ${complexity} complessità sul tema "${topic}". Genera la Rubrica e l'array di domande completo. Ogni domanda deve essere complessa e contenere un campo 'image' con un link a un placeholder di immagine se la domanda lo richiede (diagrammi, schemi, ecc.).`;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
            
            const quizSchema = {
                type: "OBJECT",
                properties: {
                    rubric: { type: "OBJECT" },
                    questions: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                id: { type: "NUMBER" },
                                text: { type: "STRING" },
                                type: { type: "STRING", enum: ["multiple-choice", "open", "closed", "practical"] },
                                points: { type: "NUMBER" },
                                correctAnswer: { type: "STRING", description: "Risposta corretta o risposta attesa/guida per la correzione." },
                                options: { type: "ARRAY", items: { type: "STRING" } },
                                image: { type: "STRING", description: "Link a placeholder immagine se necessario (es: https://placehold.co/400x250/F0F4FF/4F46E5?text=Diagramma)." }
                            },
                            required: ["id", "text", "type", "points", "correctAnswer"]
                        }
                    }
                },
                required: ["rubric", "questions"]
            };

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: quizSchema
                }
            };

            let response;
            try {
                const MAX_RETRIES = 3;
                let attempt = 0;
                while (attempt < MAX_RETRIES) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) break;

                    attempt++;
                    if (attempt < MAX_RETRIES) {
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }

                if (!response || !response.ok) {
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!jsonText) {
                     throw new Error("Risposta API non valida o vuota.");
                }

                const cleanJsonText = jsonText.replace(/```json|```/g, '').trim();
                
                const quizData = JSON.parse(cleanJsonText);
                quizData.questions = quizData.questions.map((q, idx) => ({ ...q, id: idx + 1 }));

                return quizData;
            } catch (error) {
                console.error("Errore fetch/parsing API:", error);
                throw new Error("Errore durante la comunicazione con l'AI o nel parsing della risposta.");
            }
        }

        // --- LOGICA DI CREAZIONE QUIZ E SALVATAGGIO SU DB ---

        async function createVerifications(topic, studentsData, complexity) {
            const container = document.getElementById('quiz-generator');
            const loadingArea = container.querySelector('#loading-area');
            const loadingBar = container.querySelector('.loading-bar');

            // 1. Generazione del Contenuto Base del Quiz
            loadingBar.style.width = '10%';
            loadingArea.querySelector('#status-message').textContent = "Generazione del contenuto base della verifica tramite AI...";
            let quizContent;
            try {
                quizContent = await generateQuizContent(topic, complexity);
            } catch (error) {
                console.error("Errore generazione Quiz:", error);
                showModal("Errore Generazione AI", `Impossibile generare il contenuto del quiz. Dettagli: ${error.message}. Riprova.`);
                loadingBar.style.width = '0%';
                return;
            }

            // 2. Creazione del Record Base nel DB (Quiz Generale) - Per riferimento del docente
            loadingBar.style.width = '30%';
            loadingArea.querySelector('#status-message').textContent = "Contenuto generato. Salvataggio configurazione quiz base...";
            const quizRef = await addDoc(getTeacherQuizCollection(userId), {
                topic,
                totalStudents: studentsData.length,
                classes: studentsData.map(s => s.class),
                complexity,
                creationDate: serverTimestamp(),
                baseQuestions: quizContent.questions, 
                rubric: quizContent.rubric
            });

            // 3. Creazione delle Verifiche Personalizzate per ogni Alunno
            const baseQuestions = quizContent.questions;
            const rubric = quizContent.rubric;
            const verificationLinks = [];

            for (let i = 0; i < studentsData.length; i++) {
                loadingBar.style.width = `${30 + (i / studentsData.length) * 60}%`;
                const studentInfo = studentsData[i];
                const password = Math.random().toString(36).substring(2, 8).toUpperCase(); 

                // Shuffle delle domande per differenziare la verifica
                const personalizedQuestions = [...baseQuestions].sort(() => Math.random() - 0.5);

                const verificationDoc = {
                    quizId: quizRef.id,
                    topic: topic, 
                    // Questi campi sono i dati pre-assegnati dal docente
                    assignedClass: studentInfo.class,
                    assignedCurriculum: studentInfo.curriculum, 
                    // Il nome dello studente verrà aggiunto dallo studente stesso al login
                    studentName: 'N/A', 
                    password: password,
                    status: 'pending',
                    questions: personalizedQuestions,
                    rubric: rubric,
                    creationDate: serverTimestamp(),
                    creatorId: userId 
                };

                // Per evitare problemi di concurrenza e garantire l'univocità, usiamo addDoc
                const verifRef = await addDoc(getPublicVerificationCollection(), verificationDoc);
                const verificationId = verifRef.id;

                // Modificato per utilizzare l'hash per la compatibilità con l'ambiente iframe/blob
                const verificationLink = `${window.location.origin}${window.location.pathname}#page=student-login&vId=${verificationId}`;

                verificationLinks.push({
                    name: studentInfo.name, // Nome pre-assegnato per comodità del docente
                    class: studentInfo.class,
                    link: verificationLink,
                    password: password,
                    verificationId: verificationId
                });

                loadingArea.querySelector('#status-message').textContent = `Creazione verifica per ${studentInfo.name} (${studentInfo.class})...`;
            }

            loadingBar.style.width = '100%';
            loadingArea.querySelector('#status-message').textContent = "Tutte le verifiche sono state create e salvate!";
            setTimeout(() => {
                navigate('dashboard', { links: JSON.stringify(verificationLinks) });
            }, 1000);
        }

        window.createVerifications = createVerifications;


        // --- LOGICA DI CORREZIONE E GRADING ---
        function correctVerification(questions, studentAnswers, rubric) {
            let totalScore = 0;
            let maxScore = 0;
            const correctedAnswers = [];

            questions.forEach(q => {
                maxScore += q.points;
                const studentAnswer = studentAnswers[q.id] || ''; 
                let score = 0;
                let comment = '';
                let isCorrect = false;

                if (q.type === 'multiple-choice' || q.type === 'closed') {
                    const normalizedStudentAnswer = studentAnswer.toString().toUpperCase().trim();
                    const normalizedCorrectAnswer = q.correctAnswer.toString().toUpperCase().trim();

                    if (normalizedStudentAnswer === normalizedCorrectAnswer) {
                        score = q.points;
                        comment = 'Risposta esatta. Punteggio massimo assegnato. Ottimo lavoro.';
                        isCorrect = true;
                    } else {
                        comment = `Risposta errata. La risposta corretta attesa era: "${q.correctAnswer}". Rivedi i concetti base.`;
                    }
                } else if (q.type === 'open' || q.type === 'practical') {
                    // Valutazione automatica per domande aperte e pratiche (richiede sforzo del docente per conferma)
                    if (studentAnswer.length > 50) {
                        score = Math.floor(q.points * 0.7); // 70% del punteggio per l'argomentazione
                        comment = `Risposta articolata e completa. Valutazione preliminare automatica: ${score}/${q.points} punti. Il docente dovrà confermare la valutazione sulla base della pertinenza con i criteri: ${q.correctAnswer}.`;
                        isCorrect = true; 
                    } else if (studentAnswer.length > 15) {
                         score = Math.floor(q.points * 0.4);
                         comment = `Risposta sufficiente ma poco approfondita. Valutazione preliminare: ${score}/${q.points} punti.`;
                    } else {
                        comment = 'Risposta insufficiente, mancante, o non pertinente. Punti assegnati: 0. Approfondire la preparazione.';
                    }
                }

                totalScore += score;
                correctedAnswers.push({
                    questionId: q.id,
                    answer: studentAnswer,
                    isCorrect: isCorrect,
                    score: score,
                    maxPoints: q.points,
                    comment: comment,
                    questionText: q.text,
                    questionType: q.type
                });
            });

            const percentage = maxScore > 0 ? (totalScore / maxScore) * 100 : 0;
            let finalGrade = 'Non classificato (0)';
            let finalGradeNumeric = 0;

            const ranges = Object.keys(rubric).map(range => {
                const [min, max] = range.split('-').map(Number);
                return { min, max, grade: rubric[range] };
            }).sort((a, b) => a.min - b.min); 

            for (const item of ranges) {
                if (percentage >= item.min && percentage <= item.max) {
                    finalGrade = item.grade;
                    const gradeMatch = item.grade.match(/\((\d+)\)/);
                    finalGradeNumeric = gradeMatch ? parseInt(gradeMatch[1]) : 0;
                    break;
                }
            }

            return { totalScore, maxScore, percentage, finalGrade, finalGradeNumeric, correctedAnswers };
        }

        // --- LOGICA DI SOTTOMISSIONE E CORREZIONE ---
        async function submitQuiz(verificationId) {
            const form = document.getElementById('quiz-form');
            const formData = new FormData(form);
            const studentAnswers = {};
            
            const docRef = doc(getPublicVerificationCollection(), verificationId);
            const docSnap = await getDoc(docRef);

            if (!docSnap.exists()) {
                 showModal("Errore", "Verifica non trovata. Impossibile consegnare.");
                 return;
            }
            const verificationDoc = docSnap.data();

            verificationDoc.questions.forEach(q => {
                studentAnswers[q.id] = formData.get(`q-${q.id}`) || '';
            });

            showModal("Consegna in Corso", "Stiamo correggendo la verifica e calcolando il voto in base alla griglia AI...");
            
            // La correzione include la griglia di voto
            const results = correctVerification(verificationDoc.questions, studentAnswers, verificationDoc.rubric);

            // 1. Aggiorna lo stato della verifica (Documento Pubblico)
            await setDoc(doc(getPublicVerificationCollection(), verificationId), {
                status: 'submitted',
                submissionDate: serverTimestamp(),
                // Salviamo le risposte finali per l'archiviazione del docente
                studentAnswers: results.correctedAnswers,
            }, { merge: true }); 

            // 2. Salva i risultati (Documento Risultati Pubblico)
            const resultDoc = {
                verificationId: verificationId,
                submissionDate: serverTimestamp(),
                studentName: verificationDoc.studentName,
                assignedClass: verificationDoc.assignedClass,
                curriculum: verificationDoc.curriculum,
                topic: verificationDoc.topic,
                totalScore: results.totalScore,
                maxScore: results.maxScore,
                finalGrade: results.finalGrade,
                finalGradeNumeric: results.finalGradeNumeric,
                studentAnswers: results.correctedAnswers,
                rubric: verificationDoc.rubric,
                creatorId: verificationDoc.creatorId
            };

            await setDoc(doc(getPublicResultsCollection(), verificationId), resultDoc);

            setTimeout(() => {
                navigate('results', { vId: verificationId });
            }, 1000);
        }
        window.submitQuiz = submitQuiz; 


        // --- RENDERING DELLE VISTE ---

        function renderDashboard(links = null) {
            const appContainer = document.getElementById('app-container');
            const urlParams = getRouteParams();
            const currentLinks = urlParams.get('links') ? JSON.parse(urlParams.get('links')) : (links ? JSON.parse(links) : null);
            
            let tableRows = '';

            if (verificationsData.length === 0) {
                tableRows = `
                    <tr>
                        <td colspan="7" class="py-4 text-center text-gray-500">
                            Nessuna verifica creata. Clicca "Crea Nuova Verifica" per iniziare.
                        </td>
                    </tr>
                `;
            } else {
                tableRows = verificationsData.map(v => {
                    // Prende il nome dello studente se consegnato, altrimenti usa l'assegnata dal docente
                    const studentDisplay = v.result ? v.result.studentName : (v.studentName !== 'N/A' ? v.studentName : 'In Attesa');
                    const grade = v.result ? v.result.finalGradeNumeric : 'N/A';
                    const statusColor = v.status === 'submitted' ? 'text-green-600 font-semibold' : 'text-yellow-600';
                    const date = v.creationDate ? new Date(v.creationDate.seconds * 1000).toLocaleDateString('it-IT') : 'Data sconosciuta';
                    
                    return `
                        <tr class="border-b hover:bg-gray-50 transition duration-150">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${v.assignedClass || 'N/D'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${studentDisplay}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${v.topic || 'N/D'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm ${statusColor}">${v.status === 'submitted' ? 'Consegnata' : 'In attesa'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-indigo-700">${v.status === 'submitted' ? grade : 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${date}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button onclick="navigate('results', { vId: '${v.id}' })" class="text-indigo-600 hover:text-indigo-900 disabled:opacity-50" ${v.status !== 'submitted' ? 'disabled' : ''}>
                                    ${v.status === 'submitted' ? 'Vedi Report' : 'Attendi Consegna'}
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            let linksHtml = '';
            if (currentLinks && currentLinks.length > 0) {
                 linksHtml = `
                    <div class="card p-6 mb-8 bg-green-50 border border-green-200">
                        <h3 class="text-lg font-bold text-green-800 mb-4">Verifiche create con successo!</h3>
                        <p class="text-sm text-green-700 mb-4">Condividi questi link e codici con i tuoi studenti. (Visualizzati solo dopo la generazione)</p>
                        <div class="space-y-3 max-h-64 overflow-y-auto pr-2">
                            ${currentLinks.map(l => `
                                <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-3 p-2 bg-white rounded-lg shadow-sm">
                                    <span class="font-medium text-gray-700 w-full sm:w-1/3 truncate">${l.class} - ${l.name}:</span>
                                    <span class="text-sm font-mono bg-gray-100 p-1 rounded">Codice: <strong class="text-indigo-600">${l.password}</strong></span>
                                    <input type="text" id="link-${l.verificationId}" value="${l.link}" readonly class="flex-grow text-xs border-0 focus:ring-0 w-full sm:w-auto">
                                    <button onclick="copyToClipboard('link-${l.verificationId}')" class="text-indigo-500 hover:text-indigo-700 p-1 rounded-full bg-indigo-50 hover:bg-indigo-100 transition duration-150" title="Copia Link">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7v8a2 2 0 002 2h6m-6 0v2m0-2h2m-6 0v2m0-2h2"></path></svg>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            appContainer.innerHTML = `
                <div class="flex justify-between items-center mb-6 no-print">
                    <h2 class="text-2xl font-bold text-gray-700">Dashboard Docente</h2>
                    <button onclick="navigate('generator', {links: null})" class="btn-primary px-4 py-2 rounded-lg font-semibold flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        Crea Nuova Verifica
                    </button>
                </div>

                ${linksHtml}

                <div class="card overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Classe Assegnata</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alunno (Consegnato)</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Argomento</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stato</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Voto (base 10)</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Creazione</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Azione</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }


        function renderGenerator() {
            const appContainer = document.getElementById('app-container');
            const classOptions = ALL_CLASSES.map(c => `<option value="${c}">${c}</option>`).join('');

            appContainer.innerHTML = `
                <div class="card p-6 sm:p-10" id="quiz-generator">
                    <h2 class="text-2xl font-bold text-gray-700 mb-6">Genera Nuove Verifiche Personalizzate</h2>
                    <p class="text-gray-600 mb-8">L'AI creerà versioni diverse del quiz, assegnando a ciascuno studente un codice e un link univoco.</p>
                    
                    <div id="loading-area" class="mb-6 hidden">
                        <div class="relative pt-1">
                            <div class="flex mb-2 items-center justify-between">
                                <div>
                                    <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-indigo-600 bg-indigo-200">
                                        <span id="status-message">Generazione in corso...</span>
                                    </span>
                                </div>
                            </div>
                            <div class="overflow-hidden h-2 mb-4 text-xs flex rounded-full bg-indigo-200">
                                <div class="loading-bar shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-indigo-500"></div>
                            </div>
                        </div>
                    </div>

                    <form id="generator-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label for="topic" class="block text-sm font-medium text-gray-700 mb-1">Argomento della Verifica (Es: 'Strutture Dati e Algoritmi')</label>
                                <input type="text" id="topic" name="topic" required class="w-full border-gray-300 rounded-lg shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Inserisci l'argomento">
                            </div>
                            <div>
                                <label for="complexity" class="block text-sm font-medium text-gray-700 mb-1">Livello di Complessità</label>
                                <select id="complexity" name="complexity" required class="w-full border-gray-300 rounded-lg shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500">
                                    <option value="Base">Base (Biennio)</option>
                                    <option value="Intermedia" selected>Intermedia (Triennio)</option>
                                    <option value="Avanzata">Avanzata (Esame di Stato)</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                             <div>
                                <label for="curriculum" class="block text-sm font-medium text-gray-700 mb-1">Indirizzo di Studio (Predefinito)</label>
                                <input type="text" id="curriculum" name="curriculum" value="Istituto Tecnico - Indirizzo Informatica" required class="w-full border-gray-300 rounded-lg shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Indirizzo di Studio">
                            </div>
                            <div>
                                <label for="numStudents" class="block text-sm font-medium text-gray-700 mb-1">Numero di Alunni</label>
                                <input type="number" id="numStudents" name="numStudents" value="1" min="1" max="50" required class="w-full border-gray-300 rounded-lg shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                        </div>

                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-gray-700 mb-3 flex justify-between items-center">
                                Assegnazione Studenti e Classi
                                <button type="button" id="generate-rows-btn" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                                    Aggiorna Lista
                                </button>
                            </h3>
                            <div id="students-list" class="space-y-3">
                                <!-- Le righe degli studenti verranno generate qui -->
                                <div class="student-row flex space-x-2">
                                    <input type="text" placeholder="Nome Cognome Alunno 1" class="student-name w-full border-gray-300 rounded-lg shadow-sm p-3">
                                    <select class="student-class border-gray-300 rounded-lg shadow-sm p-3 w-40">
                                        <option value="">Seleziona Classe</option>
                                        ${classOptions}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-between items-center mt-8 pt-4 border-t border-gray-200 no-print">
                            <button type="button" onclick="navigate('dashboard', {links: null})" class="text-gray-600 hover:text-gray-800 font-medium">Annulla e Torna alla Dashboard</button>
                            <button type="submit" id="generate-btn" class="btn-primary px-8 py-3 rounded-lg font-bold transition duration-150">
                                Genera 1 Verifica
                            </button>
                        </div>
                    </form>
                </div>
            `;

            const studentsList = document.getElementById('students-list');
            const numStudentsInput = document.getElementById('numStudents');
            const generateRowsBtn = document.getElementById('generate-rows-btn');
            const generateBtn = document.getElementById('generate-btn');

            function updateStudentRows() {
                const num = parseInt(numStudentsInput.value) || 1;
                let currentRows = studentsList.querySelectorAll('.student-row');
                const diff = num - currentRows.length;

                // Rimuovi righe in eccesso
                if (diff < 0) {
                    for (let i = 0; i < Math.abs(diff); i++) {
                        studentsList.removeChild(studentsList.lastElementChild);
                    }
                } 
                // Aggiungi nuove righe
                else if (diff > 0) {
                    for (let i = 0; i < diff; i++) {
                        const count = currentRows.length + i + 1;
                        const newRow = document.createElement('div');
                        newRow.className = 'student-row flex space-x-2';
                        newRow.innerHTML = `
                            <input type="text" placeholder="Nome Cognome Alunno ${count}" class="student-name w-full border-gray-300 rounded-lg shadow-sm p-3">
                            <select class="student-class border-gray-300 rounded-lg shadow-sm p-3 w-40">
                                <option value="">Seleziona Classe</option>
                                ${classOptions}
                            </select>
                        `;
                        studentsList.appendChild(newRow);
                    }
                }

                generateBtn.textContent = `Genera ${num} Verifiche`;
            }

            // Inizializza le righe (chiamata per il default di 1)
            updateStudentRows();

            // Ascolta il cambio del numero di alunni o il click su Aggiorna Lista
            numStudentsInput.onchange = updateStudentRows;
            generateRowsBtn.onclick = updateStudentRows;

            // Logica di Sottomissione del Form
            document.getElementById('generator-form').onsubmit = async (e) => {
                e.preventDefault();

                const form = e.target;
                const topic = form.topic.value.trim();
                const complexity = form.complexity.value;
                const curriculum = form.curriculum.value.trim();
                
                const studentRows = document.querySelectorAll('.student-row');
                const studentsData = [];

                let missingData = false;
                studentRows.forEach(row => {
                    const name = row.querySelector('.student-name').value.trim();
                    const studentClass = row.querySelector('.student-class').value;

                    if (name && studentClass) {
                        studentsData.push({ name, class: studentClass, curriculum });
                    } else if (name || studentClass) {
                        // Se ne manca uno, è un errore di compilazione
                        missingData = true; 
                    }
                });

                if (missingData) {
                    showModal("Attenzione", "Assicurati che tutti gli alunni inseriti abbiano sia il Nome/Cognome che la Classe assegnata.");
                    return;
                }
                
                if (!topic || !curriculum || studentsData.length === 0) {
                    showModal("Attenzione", "Compila l'argomento, l'indirizzo di studio e inserisci almeno un alunno completo.");
                    return;
                }

                document.getElementById('loading-area').classList.remove('hidden');
                document.getElementById('generate-btn').disabled = true;

                await createVerifications(topic, studentsData, complexity);

                document.getElementById('loading-area').classList.add('hidden');
                document.getElementById('generate-btn').disabled = false;
            };
        }

        async function renderStudentLogin() {
            const appContainer = document.getElementById('app-container');
            const urlParams = getRouteParams();
            const verificationId = urlParams.get('vId');

            if (!verificationId) {
                appContainer.innerHTML = `<div class="card p-6 text-center text-red-600">Errore: ID Verifica non specificato.</div>`;
                return;
            }

            // Fetch della verifica per mostrare i dati pre-assegnati dal docente
            const docRef = doc(getPublicVerificationCollection(), verificationId);
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists()) {
                appContainer.innerHTML = `<div class="card p-6 text-center text-red-600">Errore: Verifica non trovata o scaduta.</div>`;
                return;
            }
            const verificationDoc = docSnap.data();

            if (verificationDoc.status === 'submitted') {
                 appContainer.innerHTML = `<div class="card p-6 text-center text-yellow-600">Questa verifica è già stata consegnata. <button onclick="navigate('results', { vId: '${verificationId}' })" class="text-indigo-600 hover:underline">Vedi il report qui.</button></div>`;
                 return;
            }
            
            appContainer.innerHTML = `
                <div class="card p-6 sm:p-10 max-w-lg mx-auto">
                    <h2 class="text-2xl font-bold text-indigo-700 mb-2">Accesso alla Verifica</h2>
                    <p class="text-gray-600 mb-4">Verifica assegnata a: <span class="font-semibold text-gray-800">${verificationDoc.assignedClass}</span> - Argomento: <span class="font-semibold text-gray-800">${verificationDoc.topic}</span></p>
                    <p class="text-sm text-gray-500 mb-6">Inserisci i tuoi dati e il codice univoco fornito dal docente.</p>
                    
                    <div id="login-status" class="hidden p-3 mb-4 rounded-lg text-sm font-medium"></div>
                    
                    <form id="student-login-form">
                        <input type="hidden" name="verificationId" value="${verificationId}">
                        
                        <div class="mb-4 space-y-3">
                            <div>
                                <label for="studentName" class="block text-sm font-medium text-gray-700 mb-1">Nome e Cognome</label>
                                <input type="text" id="studentName" name="studentName" required class="w-full border-gray-300 rounded-lg shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Mario Rossi">
                            </div>
                            <div>
                                <label for="studentCurriculum" class="block text-sm font-medium text-gray-700 mb-1">Indirizzo di Studio</label>
                                <input type="text" id="studentCurriculum" name="studentCurriculum" value="${verificationDoc.assignedCurriculum || ''}" required class="w-full border-gray-300 rounded-lg shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Es: Liceo Scientifico">
                            </div>
                            <div>
                                <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Data Odierna</label>
                                <input type="date" id="date" name="date" value="${new Date().toISOString().split('T')[0]}" required class="w-full border-gray-300 rounded-lg shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                        </div>

                        <div class="mb-6">
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Codice di Accesso</label>
                            <input type="text" id="password" name="password" required class="w-full border-gray-300 rounded-lg shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500 uppercase tracking-widest text-center text-lg" placeholder="ES: AB12CD">
                        </div>

                        <button type="submit" class="w-full btn-primary px-4 py-3 rounded-lg font-bold transition duration-150">
                            Avvia la Verifica
                        </button>
                    </form>
                </div>
            `;

            document.getElementById('student-login-form').onsubmit = async (e) => {
                e.preventDefault();
                const form = e.target;
                const studentName = form.studentName.value.trim();
                const studentCurriculum = form.studentCurriculum.value.trim();
                const enteredPassword = form.password.value.toUpperCase().trim();
                const date = form.date.value.trim();
                const statusDiv = document.getElementById('login-status');

                statusDiv.classList.remove('hidden');
                statusDiv.className = 'p-3 mb-4 rounded-lg text-sm font-medium bg-indigo-100 text-indigo-800';
                statusDiv.textContent = 'Verifica codice...';

                try {
                    // Controllo password
                    if (verificationDoc.password !== enteredPassword) {
                        statusDiv.className = 'p-3 mb-4 rounded-lg text-sm font-medium bg-red-100 text-red-800';
                        statusDiv.textContent = 'Codice di accesso errato. Riprova.';
                        return;
                    }
                    
                    // Aggiorna il documento con i dati dello studente (necessario per il report)
                    await setDoc(doc(getPublicVerificationCollection(), verificationId), {
                        studentName: studentName,
                        curriculum: studentCurriculum,
                        quizDate: date, // Salviamo la data
                        // Lo stato rimane 'pending' finché non consegna
                    }, { merge: true });

                    // Successo: Avvia il Quiz
                    navigate('quiz', { vId: verificationId });

                } catch (error) {
                    console.error("Errore di accesso:", error);
                    statusDiv.className = 'p-3 mb-4 rounded-lg text-sm font-medium bg-red-100 text-red-800';
                    statusDiv.textContent = 'Si è verificato un errore tecnico. Riprova.';
                }
            };
        }

        async function renderQuiz() {
            const appContainer = document.getElementById('app-container');
            const urlParams = getRouteParams();
            const verificationId = urlParams.get('vId');
            
            appContainer.innerHTML = `<div class="card p-6 text-center text-indigo-600 font-medium">Caricamento della verifica...</div>`;

            try {
                const docRef = doc(getPublicVerificationCollection(), verificationId);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    appContainer.innerHTML = `<div class="card p-6 text-center text-red-600">Errore: Verifica non trovata.</div>`;
                    return;
                }

                const verificationDoc = docSnap.data();
                
                if (verificationDoc.status === 'pending' && verificationDoc.studentName === 'N/A') {
                    // Forza il reindirizzamento al login se manca il nome dello studente
                     navigate('student-login', { vId: verificationId });
                     return;
                }
                if (verificationDoc.status === 'submitted') {
                    appContainer.innerHTML = `<div class="card p-6 text-center text-yellow-600">Questa verifica è già stata consegnata. <button onclick="navigate('results', { vId: '${verificationId}' })" class="text-indigo-600 hover:underline">Vedi il report qui.</button></div>`;
                    return;
                }

                const questionsHtml = verificationDoc.questions.map((q, index) => {
                    let inputField;
                    const qId = q.id;

                    if (q.type === 'multiple-choice') {
                        inputField = q.options.map((option, optIndex) => `
                            <div class="flex items-center">
                                <input id="q-${qId}-opt-${optIndex}" name="q-${qId}" type="radio" value="${option}" required class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                                <label for="q-${qId}-opt-${optIndex}" class="ml-3 block text-sm font-medium text-gray-700">${option}</label>
                            </div>
                        `).join('');
                    } else if (q.type === 'closed') {
                         inputField = `
                            <input type="text" name="q-${qId}" required class="w-full border-gray-300 rounded-lg shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Risposta breve e precisa">
                        `;
                    } else if (q.type === 'open' || q.type === 'practical') {
                        inputField = `
                            <textarea name="q-${qId}" rows="6" required class="w-full border-gray-300 rounded-lg shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Scrivi la tua risposta dettagliata e argomentata qui..."></textarea>
                        `;
                    }

                    // Aggiunta dell'attributo onload per la gestione degli errori delle immagini
                    const imageHtml = q.image ? `<img src="${q.image}" onerror="this.onerror=null; this.src='https://placehold.co/400x250/F0F4FF/4F46E5?text=DIAGRAMMA+NON+DISPONIBILE';" alt="Diagramma o Immagine di riferimento" class="my-4 rounded-lg shadow-md max-w-full h-auto mx-auto md:max-w-lg">` : '';

                    return `
                        <div class="mb-8 p-6 bg-white border border-gray-200 rounded-xl shadow-lg quiz-question">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-lg font-semibold text-gray-800">${index + 1}. ${q.text}</h3>
                                <span class="text-sm font-bold text-indigo-600 p-1 bg-indigo-50 rounded-lg">${q.points} Punti</span>
                            </div>
                            ${imageHtml}
                            <div class="mt-4 space-y-3 quiz-content">
                                ${inputField}
                            </div>
                        </div>
                    `;
                }).join('');
                

                appContainer.innerHTML = `
                    <div class="card p-6 sm:p-10" id="printable-area">
                        <header class="mb-8 border-b pb-4">
                            <h1 class="text-3xl font-extrabold text-gray-900">${verificationDoc.topic || 'Verifica In Formato Digitale'}</h1>
                            <p class="text-md text-gray-600 mt-2">
                                Alunno: <span class="font-semibold">${verificationDoc.studentName}</span> | Classe Assegnata: <span class="font-semibold">${verificationDoc.assignedClass}</span>
                            </p>
                            <p class="text-sm text-gray-500">Indirizzo di Studio: ${verificationDoc.curriculum || 'N/D'} | Data: ${verificationDoc.quizDate || 'N/D'}</p>
                        </header>

                        <form id="quiz-form" onsubmit="event.preventDefault(); submitQuiz('${verificationId}')">
                            ${questionsHtml}
                            
                            <div class="flex justify-center mt-10 no-print">
                                <button type="submit" class="btn-primary px-12 py-3 rounded-xl font-bold text-lg shadow-xl hover:shadow-2xl transition duration-300">
                                    Consegna e Avvia Correzione Automatica
                                </button>
                            </div>
                        </form>
                    </div>
                `;

            } catch (error) {
                console.error("Errore nel rendering del quiz:", error);
                appContainer.innerHTML = `<div class="card p-6 text-center text-red-600">Impossibile caricare la verifica. Dettagli: ${error.message}</div>`;
            }
        }

        async function renderResults() {
            const appContainer = document.getElementById('app-container');
            const urlParams = getRouteParams();
            const verificationId = urlParams.get('vId');

            appContainer.innerHTML = `<div class="card p-6 text-center text-indigo-600 font-medium">Caricamento dei risultati...</div>`;

            try {
                const docRef = doc(getPublicResultsCollection(), verificationId);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    appContainer.innerHTML = `<div class="card p-6 text-center text-yellow-600">Risultati non ancora disponibili o verifica non consegnata.</div>`;
                    return;
                }

                const resultDoc = docSnap.data();
                
                const grade = resultDoc.finalGradeNumeric || 0;
                const gradeText = resultDoc.finalGrade || 'Non Classificato';
                const gradeColor = grade >= 6 ? 'border-green-600 bg-green-50 text-green-700' : (grade === 0 ? 'border-gray-500 bg-gray-50 text-gray-700' : 'border-red-600 bg-red-50 text-red-700');
                const submissionDate = resultDoc.submissionDate ? new Date(resultDoc.submissionDate.seconds * 1000).toLocaleDateString('it-IT') : 'N/D';

                const correctionsHtml = resultDoc.studentAnswers.map((answer, index) => {
                    const isFullyCorrect = answer.score === answer.maxPoints && answer.maxPoints > 0;
                    const isPartiallyCorrect = answer.score > 0 && answer.score < answer.maxPoints;
                    const answerColor = isFullyCorrect ? 'border-green-400' : (isPartiallyCorrect ? 'border-yellow-400' : 'border-red-400');
                    const headerBg = isFullyCorrect ? 'bg-green-50' : (isPartiallyCorrect ? 'bg-yellow-50' : 'bg-red-50');

                    let icon;
                    if (isFullyCorrect) { icon = '<svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>'; } 
                    else if (isPartiallyCorrect) { icon = '<svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'; } 
                    else { icon = '<svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>'; }
                    
                    return `
                        <div class="mb-6 p-0 border-l-4 ${answerColor} bg-white rounded-lg shadow-md overflow-hidden print:shadow-none print:border-l-8 print:mb-4">
                            <div class="flex justify-between items-center px-4 py-3 ${headerBg}">
                                <h4 class="text-md font-semibold text-gray-800">Domanda ${index + 1}: ${answer.questionText}</h4>
                                <div class="flex items-center space-x-2">
                                    ${icon}
                                    <span class="text-lg font-bold text-gray-900">${answer.score}/${answer.maxPoints}</span>
                                </div>
                            </div>
                            
                            <div class="p-4 print:p-2">
                                <p class="text-sm font-medium text-gray-700 mb-2">Risposta dello studente:</p>
                                <div class="p-3 border rounded-lg bg-gray-50 text-gray-800 whitespace-pre-wrap print:border-dashed print:border-gray-300 print:bg-white print:text-sm">${answer.answer || '<em class="text-gray-400">Nessuna risposta fornita.</em>'}</div>
                                
                                <p class="text-sm font-medium mt-3 mb-1 text-indigo-700">Commento di Correzione (AI):</p>
                                <p class="text-sm text-gray-800 italic print:text-xs">${answer.comment}</p>
                            </div>
                        </div>
                    `;
                }).join('');

                const rubricHtml = Object.entries(resultDoc.rubric).map(([range, grade]) => `
                    <div class="flex justify-between p-2 border-b">
                        <span class="text-sm text-gray-600">${range}%</span>
                        <span class="text-sm font-medium">${grade}</span>
                    </div>
                `).join('');


                appContainer.innerHTML = `
                    <div class="card p-6 sm:p-10 print:p-0" id="printable-area">
                        <!-- HEADER UFFICIALE (VISIBILE SOLO IN STAMPA/PDF) -->
                        <header class="official-header hidden print:block">
                            <h1 class="text-xl font-extrabold text-gray-900 text-center mb-1">ISTITUTO TECNICO SUPERIORE "ALAN TURING" (SCUOLA SUPERIORE STATALE)</h1>
                            <p class="text-xs text-center text-gray-600">Via Archimede, 42 - Seregno (MB) | Protocollo N. ${Math.floor(Math.random() * 900000 + 100000)}/${new Date().getFullYear()}</p>
                            <p class="text-sm text-center text-gray-800 font-bold mt-3">VERIFICA SCRITTA UFFICIALE - A.S. ${new Date().getFullYear()}/${new Date().getFullYear() + 1}</p>
                        </header>
                        
                        <div class="flex justify-between items-start mb-6 border-b pb-4 no-print">
                            <div>
                                <h1 class="text-3xl font-extrabold text-gray-900">${resultDoc.topic}</h1>
                                <p class="text-md text-gray-600 mt-1">Report di Verifica Finale | Tipo: ${resultDoc.curriculum || 'Indirizzo Sconosciuto'}</p>
                            </div>
                            <button onclick="window.print()" class="btn-primary px-4 py-2 rounded-lg font-semibold flex items-center shadow-lg hover:shadow-xl transition duration-150">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2z"></path></svg>
                                Stampa / Salva PDF (Archiviazione)
                            </button>
                        </div>
                        
                        <section class="mb-8 grid grid-cols-1 lg:grid-cols-4 gap-6 print:grid-cols-4 print:gap-4 print:mb-4">
                            <div class="card p-5 bg-white shadow-lg lg:col-span-2 print:col-span-2 print:border print:shadow-none print:p-2">
                                <h2 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2 print:text-lg">Dati Alunno e Consegna</h2>
                                <div class="space-y-2 text-gray-700 print:text-sm print:space-y-1">
                                    <p><strong>Nome Alunno:</strong> ${resultDoc.studentName}</p>
                                    <p><strong>Classe:</strong> ${resultDoc.assignedClass}</p>
                                    <p><strong>Indirizzo:</strong> ${resultDoc.curriculum}</p>
                                    <p><strong>Data Consegna:</strong> ${submissionDate}</p>
                                </div>
                            </div>
                            
                            <div class="card p-5 shadow-xl border-b-4 ${gradeColor} lg:col-span-1 print:col-span-1 print:border print:shadow-none print:p-2">
                                <h2 class="text-xl font-bold mb-2 print:text-lg">Voto Finale</h2>
                                <p class="text-6xl font-extrabold print:text-5xl">${grade}</p>
                                <p class="text-lg font-medium mt-1 print:text-sm">${gradeText}</p>
                            </div>
                             <div class="card p-5 shadow-xl border-b-4 border-indigo-500 bg-indigo-50 text-indigo-700 lg:col-span-1 print:col-span-1 print:border print:shadow-none print:p-2">
                                <h2 class="text-xl font-bold mb-2 print:text-lg">Punteggio Totale</h2>
                                <p class="text-6xl font-extrabold print:text-5xl">${resultDoc.totalScore}<span class="text-2xl font-normal print:text-lg"> / ${resultDoc.maxScore}</span></p>
                                <p class="text-lg font-medium mt-1 print:text-sm">Percentuale: ${(resultDoc.totalScore / resultDoc.maxScore * 100).toFixed(1)}%</p>
                            </div>
                        </section>
                        
                        <section class="mb-8 print:mb-4">
                            <h2 class="text-2xl font-bold text-gray-700 mb-4 print:text-xl print:border-b print:pb-2">Correzione Dettagliata (AI con Commenti)</h2>
                            <div class="space-y-4 print:space-y-2">
                                ${correctionsHtml}
                            </div>
                        </section>

                        <section class="mb-8 border-t pt-6 print:border-t-0 print:pt-0">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 print:grid-cols-2 print:gap-4">
                                <div class="card p-5 bg-white shadow-lg print:border print:shadow-none print:p-2">
                                    <h3 class="text-lg font-semibold mb-3 print:text-base">Griglia di Valutazione Ufficiale</h3>
                                    ${rubricHtml}
                                </div>
                                <div class="card p-5 bg-white shadow-lg print:border print:shadow-none print:p-2">
                                    <h3 class="text-lg font-semibold mb-3 print:text-base">Spazio Archiviazione / Firma</h3>
                                    <div class="mt-4 grid grid-cols-2 gap-6 text-sm">
                                        <div>
                                            <p>La Segreteria</p>
                                            <div class="signature-area border-b border-gray-400 mt-8 print:mt-10"></div>
                                        </div>
                                        <div>
                                            <p>Il Docente</p>
                                            <div class="signature-area border-b border-gray-400 mt-8 print:mt-10"></div>
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-4 print:mt-2">Il presente documento è valido per l'archiviazione. Data di Archivio: ${new Date().toLocaleDateString('it-IT')}</p>
                                </div>
                            </div>
                        </section>
                        
                        <footer class="mt-8 pt-4 border-t border-gray-200 flex justify-center no-print">
                            <button onclick="navigate('dashboard', {vId: null, links: null})" class="text-indigo-600 hover:text-indigo-800 font-medium">
                                Torna alla Dashboard Docente
                            </button>
                        </footer>
                    </div>
                `;

            } catch (error) {
                console.error("Errore nel rendering dei risultati:", error);
                appContainer.innerHTML = `<div class="card p-6 text-center text-red-600">Impossibile caricare i risultati. Verifica che la verifica sia stata consegnata.</div>`;
            }
        }


        function renderApp() {
            const urlParams = getRouteParams();
            const verificationId = urlParams.get('vId');
            
            // Logica di routing semplice
            if (verificationId) {
                // Utente studente
                if (currentRoute === 'quiz') {
                    renderQuiz();
                } else if (currentRoute === 'results') {
                     renderResults();
                } else {
                    renderStudentLogin(); // Login di default per lo studente
                }
            } else {
                // Utente docente
                if (currentRoute === 'generator') {
                    renderGenerator();
                } else {
                    renderDashboard();
                }
            }
        }
        
        // --- AVVIO APP ---
        initializeAppAndAuth();

    </script>
</body>
</html>
